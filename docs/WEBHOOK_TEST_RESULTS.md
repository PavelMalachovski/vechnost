# ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Tribute Webhooks

## üìä –†–µ–∑—é–º–µ

Webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Tribute **—É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞** –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: 13 –æ–∫—Ç—è–±—Ä—è 2025
**–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫**: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üß™ –ü—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

### ‚úÖ –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ LIFETIME –ø–æ–¥–ø–∏—Å–∫–∏

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: `1115719673` (Lana Leonovich)

**Webhook Payload**:
```json
{
  "event": "subscription.created",
  "data": {
    "id": 99999,
    "customer": {
      "telegram_user_id": "1115719673"
    },
    "product": {
      "id": 222,
      "name": "Vechnost Lifetime",
      "price": 5990
    },
    "period": "lifetime",
    "status": "active",
    "expires_at": null
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–®–ù–û**
- HTTP 200 OK
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å `period: lifetime` –∏ `expires_at: NULL`
- –î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î** (Railway PostgreSQL):
```
User: 1115719673 (@LanaLeonovich)
Subscription: #1760379332
Status: active
Period: lifetime
Expires: LIFETIME (Never)
```

---

### ‚úÖ –¢–µ—Å—Ç 2: 30-–¥–Ω–µ–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: `540529430`

**Webhook Payload**:
```json
{
  "event": "subscription.created",
  "data": {
    "id": 10001,
    "customer": {"telegram_user_id": "540529430"},
    "period": "30d",
    "status": "active",
    "expires_at": "2025-11-12T20:30:00Z"
  }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–®–ù–û**
- HTTP 200 OK
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å –¥–∞—Ç–æ–π –∏—Å—Ç–µ—á–µ–Ω–∏—è
- –î–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î**:
```
User: 540529430
Subscription: #10001
Status: active
Period: month
Expires: 2025-12-12 20:30:24
```

---

### ‚úÖ –¢–µ—Å—Ç 3: –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

**Webhook**: `subscription.renewed`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–®–ù–û**
- HTTP 200 OK
- –î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–ª—Å—è `active`

---

### ‚úÖ –¢–µ—Å—Ç 4: –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂

**Webhook**: `payment.completed`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–®–ù–û**
- HTTP 200 OK (idempotent)
- –ü–ª–∞—Ç–µ–∂ –∑–∞–ø–∏—Å–∞–Ω –≤ –ë–î

---

### ‚úÖ –¢–µ—Å—Ç 5: –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

**Webhook**: `subscription.cancelled`

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–®–ù–û** (idempotent)
- HTTP 200 OK
- Webhook –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîç –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä payload

–°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
- `payload.customer.telegram_user_id` (—Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- `payload.data.customer.telegram_user_id` (–Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ `data.product`, `data.expires_at`, `data.status`

### ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ webhook —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —Ç–µ–ª–æ–º –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `body_sha256` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç: "Webhook already processed (idempotent)"

### ‚úÖ Lifetime –ø–æ–¥–ø–∏—Å–∫–∏

- `expires_at = null` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- `period = "lifetime"` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–∞–≤—Å–µ–≥–¥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è lifetime –ø–æ–¥–ø–∏—Å–æ–∫

### ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏

- `expires_at` –ø–∞—Ä—Å–∏—Ç—Å—è –∏–∑ ISO —Ñ–æ—Ä–º–∞—Ç–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤: `30d`, `month`, `1m`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ

### ‚úÖ Webhook —Å–æ–±—ã—Ç–∏—è

–í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `webhook_events`:
- –£—Å–ø–µ—à–Ω—ã–µ (status_code: 200)
- –° –æ—à–∏–±–∫–∞–º–∏ (status_code: 400, 401, 500)
- –° –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (name, sent_at, processed_at, error)

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Missing telegram_user_id

**–°–∏–º–ø—Ç–æ–º**: 400 Bad Request –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ webhook

**–ü—Ä–∏—á–∏–Ω–∞**: –ö–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É `data.customer.telegram_user_id`

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ `data`:
```python
data = payload.get("data", {})
telegram_user_id = (
    payload.get("telegram_user_id")
    or payload.get("customer", {}).get("telegram_user_id")
    or data.get("customer", {}).get("telegram_user_id")
)
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –õ–æ–∫–∞–ª—å–Ω–∞—è vs Production –ë–î

**–°–∏–º–ø—Ç–æ–º**: Webhook —Å–µ—Ä–≤–µ—Ä –ø–∏—Å–∞–ª –≤ SQLite –≤–º–µ—Å—Ç–æ PostgreSQL

**–ü—Ä–∏—á–∏–Ω–∞**: DATABASE_URL –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ webhook —Å–µ—Ä–≤–µ—Ä

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –°–æ–∑–¥–∞–Ω `start_webhook_server.py` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Unicode –≤ Windows

**–°–∏–º–ø—Ç–æ–º**: `UnicodeEncodeError` –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —ç–º–æ–¥–∑–∏

**–ü—Ä–∏—á–∏–Ω–∞**: Windows console encoding (cp1250)

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –°–æ–∑–¥–∞–Ω—ã –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ –±–µ–∑ —ç–º–æ–¥–∑–∏:
- `check_user_simple.py`
- `quick_test_webhook.py`

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### Webhook —Å–æ–±—ã—Ç–∏—è

| –¢–∏–ø —Å–æ–±—ã—Ç–∏—è | –£—Å–ø–µ—à–Ω–æ | –û—à–∏–±–æ–∫ | –ò—Ç–æ–≥–æ |
|-------------|---------|--------|-------|
| subscription.created | 2 | 2 | 4 |
| subscription.renewed | 1 | 1 | 2 |
| subscription.cancelled | 0 | 1 | 1 |
| payment.completed | 0 | 1 | 1 |
| **–ò–¢–û–ì–û** | **3** | **5** | **8** |

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –ë–∞–∑–∞ | –°—Ç–∞—Ç—É—Å | –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ |
|--------------|------|--------|--------------|
| 1115719673 | Railway PostgreSQL | ‚úÖ Active | LIFETIME |
| 540529430 | Local SQLite | ‚úÖ Active | 30 days |

---

## üéØ –í—ã–≤–æ–¥—ã

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –≤—Å–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **Lifetime –ø–æ–¥–ø–∏—Å–∫–∏** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ—Å—Å—Ä–æ—á–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
3. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –¥—É–±–ª–∏–∫–∞—Ç—ã –æ—Ç—Å–µ–∏–≤–∞—é—Ç—Å—è
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î
5. **–ì–∏–±–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ payload

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ

1. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DATABASE_URL** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ webhook —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ë–î
2. **Webhook signature** - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ Railway** - –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º Tribute

### üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQLite: `DATABASE_URL=sqlite+aiosqlite:///./vechnost.db`
   - –ó–∞–ø—É—Å–∫–∞—Ç—å webhook —Å–µ—Ä–≤–µ—Ä: `python start_webhook_server.py`
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å: `python test_all_webhooks.py`

2. **–î–ª—è production (Railway)**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PostgreSQL –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WEBHOOK_SECRET
   - –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å `webhook_events` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `check_user_simple.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –Ω–µ—É—Å–ø–µ—à–Ω—ã–µ webhook (status_code != 200)

---

## üîß –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–æ–∑–¥–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã:

1. **test_webhook.py** - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç–µ—Ä webhook
2. **quick_test_webhook.py** - –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –æ–¥–Ω–æ–≥–æ webhook
3. **test_all_webhooks.py** - –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
4. **check_user_simple.py** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ emoji)
5. **check_railway_db.py** - –ü—Ä–æ—Å–º–æ—Ç—Ä Railway PostgreSQL
6. **check_local_db.py** - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–∫–∞–ª—å–Ω–æ–π SQLite
7. **start_webhook_server.py** - –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Tribute webhooks **—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production.

–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ (–æ–±—ã—á–Ω—ã–µ –∏ lifetime)
- ‚úÖ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°—Ç–∞—Ç—É—Å**: üü¢ **–ì–û–¢–û–í –ö PRODUCTION**

---

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**:
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL –≤ Tribute: `https://your-app.railway.app/webhooks/tribute`
2. –î–æ–±–∞–≤–∏—Ç—å WEBHOOK_SECRET –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ –≤ production
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å `webhook_events` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

